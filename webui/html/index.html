<!doctype html>
<html class="no-js" lang="zh-cn">

<head>
    <meta charset="utf-8">
    <meta http-equiv="x-ua-compatible" content="ie=edge">
    <title>Blockchain Dashboard</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="shortcut icon" type="image/png" href="assets/images/icon/favicon.ico">
    <link rel="stylesheet" href="assets/css/bootstrap.min.css">
    <link rel="stylesheet" href="assets/css/font-awesome.min.css">
    <link rel="stylesheet" href="assets/css/themify-icons.css">
    <link rel="stylesheet" href="assets/css/metisMenu.css">
    <link rel="stylesheet" href="assets/css/owl.carousel.min.css">
    <link rel="stylesheet" href="assets/css/slicknav.min.css">
    <link rel="stylesheet" href="assets/css/typography.css">
    <link rel="stylesheet" href="assets/css/default-css.css">
    <link rel="stylesheet" href="assets/css/styles.css">
    <link rel="stylesheet" href="assets/css/responsive.css">
    <link rel="stylesheet" href="assets/css/jquery.toast.css">
    <!-- modernizr css -->
    <script src="assets/js/vendor/modernizr-2.8.3.min.js" type="text/javascript"></script>
</head>

<body class="body-bg">
<!--[if lt IE 8]>
<p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="http://browsehappy.com/">upgrade
    your browser</a> to improve your experience.</p>
<![endif]-->
<!-- preloader area start
<div id="preloader">
    <div class="loader"></div>
</div> -->
<!-- preloader area end -->
<!-- main wrapper start -->
<div class="horizontal-main-wrapper">
    <!-- main header area start -->
    <div class="mainheader-area">
        <div class="container">
            <div class="row align-items-center">
                <div class="col-md-3">
                    <h4 class="page-title pull-left">Blockchain Dashboard</h4>
                </div>
                <!-- profile info & task notification -->
                <div class="col-md-9 clearfix text-right">
                    <div class="d-md-inline-block d-block mr-md-4">
                        <ul class="notification-area" style="top:10px;">
                            <li class="dropdown">
                                <i class="ti-world dropdown-toggle" data-toggle="dropdown">
                                </i>
                                <div class="dropdown-menu bell-notify-box notify-box">
                                    <span class="notify-title">连接的对等节点</span>
                                    <div class="nofity-list" id="peer_list">
                                    </div>
                                </div>
                            </li>
                        </ul>
                    </div>

                    <div class="clearfix d-md-inline-block d-block">
                        <div class="user-profile m-0">
                            <h4 class="user-name" id="node-addr">0.0.0.0</h4>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <!-- main header area end -->

    <!-- page title area end -->
    <div class="main-content-inner">
        <div class="container">

            <!-- sales report area start -->
            <div class="sales-report-area mt-5">
                <div class="row">
                    <div class="col-md-6">
                        <div class="single-report mb-xs-30" style="height: 363px;">
                            <div class="s-report-inner pr--20 pt--30">
                                <div class="icon"><i class="fa fa-btc"></i></div>
                                <div class="s-report-title d-flex justify-content-between">
                                    <h4 class="header-title mb-0">余额</h4>
                                    <!-- <p>24 H</p>-->
                                </div>
                                <div class="d-flex justify-content-between pb-2">
                                    <h2 id="balance"><i class="fa fa-btc"></i> 0</h2>
                                    <span><button type="button"
                                                  class="btn  btn-xs mb-3 btn-rounded btn-light ">Refresh</button></span>
                                </div>
                            </div>
                            <div class="list-group wallets">
                                <span style="margin-left: 20px;">钱包</span>
                                <div style="height: 200px;overflow-y: scroll;margin-bottom: 10px;" id="wallets">
                                </div>
                            </div>
                        </div>
                    </div>
                    <!--<div class="col-md-4">
                        <div class="single-report mb-xs-30">
                            <div class="s-report-inner pr--20 pt--30 mb-3">
                                <div class="icon"><i class="fa fa-link"></i></div>
                                <div class="s-report-title d-flex justify-content-between">
                                    <h4 class="header-title mb-0">区块高度</h4>
                                </div>
                                <div class="d-flex justify-content-between pb-2">
                                    <h2>44</h2>
                                </div>
                            </div>

                            <div class="list-group blockinfo">
                                <li class="list-group-item d-flex justify-content-between align-items-center">
                                    节点数量
                                    <span class="badge  badge-pill">9</span>
                                </li>
                                <li class="list-group-item d-flex justify-content-between align-items-center">
                                    交易数量
                                    <span class="badge  badge-pill">9</span>
                                </li>
                                <button type="button"
                                        class="list-group-item list-group-item-action d-flex justify-content-between align-items-center">
                                    19t3ro5zutofWoYGarHmFDpoEbvrCWRHCU
                                    <span class="badge  badge-pill"><i class="fa fa-btc"></i> 14</span>
                                </button>
                                <button type="button"
                                        class="list-group-item list-group-item-action d-flex justify-content-between align-items-center">
                                    1AqjFvGkSLVcAoA1jvczBzrm6ae74zEjWM<span class="badge  badge-pill"><i
                                                class="fa fa-btc"></i> 14</span>

                                </button>
                                <button type="button"
                                        class="list-group-item list-group-item-action d-flex justify-content-between align-items-center">
                                    168C3RJbprmpnxNry49ftjWGfFGQTNeDsU<span class="badge  badge-pill"><i
                                                class="fa fa-btc"></i> 14</span></button>
                            </div>

                        </div>
                    </div>
                    -->
                    <!--
                    <div class="col-md-4">
                        <div class="single-report mb-xs-30">
                            <div class="s-report-inner pr--20 pt--30 mb-3">
                                <div class="icon"><i class="fa fa-money"></i></div>
                                <div class="s-report-title d-flex justify-content-between">
                                    <h4 class="header-title mb-0">创建交易</h4>
                                </div>

                            </div>
                            <div class="exhcange-rate"  style="margin: 1.6rem">
                                <form action="index.html#">
                                    <div class="input-form">
                                        <input type="text" value="0.76834">
                                        <span>BTC</span>
                                    </div>
                                    <div class="input-form mt-3">
                                        <input type="text" value="5689.846">
                                        <span>PayTo</span>
                                    </div>
                                    <div class="exchange-btn">
                                        <button type="submit">提交</button>
                                    </div>
                                </form>
                            </div>
                        </div>
                    </div> -->
                    <div class="col-md-6">
                        <div class="card" style="border-radius: 0px;height: 363px;">
                            <div class="card-body">
                                <h4 class="header-title">创建交易</h4>
                                <div class="exhcange-rate">
                                    <form action="">
                                        <div class="input-form">
                                            <input type="number" value="" id="tx_amount">
                                            <span>BTC</span>
                                        </div>
                                        <div class="input-form mt-3">
                                            <input type="text" value="" id="tx_to">
                                            <span>PayTo</span>
                                        </div>
                                        <div class="exchange-btn">
                                            <button id="submit_tx" type="button">提交</button>
                                        </div>
                                    </form>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <!-- sales report area end -->

            <div class="row mt-5" id="blocks-list-row">

                <!-- timeline area start -->
                <div class="col-lg-3">
                    <div class="card" style="height: 500px;">
                        <div class="card-body">
                            <h4 class="header-title">区块</h4>
                            <div class="timeline-area" id="blocks">

                            </div>
                        </div>
                    </div>
                </div>
                <!-- timeline area end -->

                <!-- Live Crypto Price area start -->
                <div class="col-lg-3">
                    <div class="card" style="height: 500px;">
                        <div class="card-body">
                            <h4 class="header-title">交易列表</h4>
                            <div class="cripto-live mt-2">
                                <ul id="tx_list" style="height: 410px;overflow-y: scroll" id="txlist">
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>
                <!-- Live Crypto Price area end -->

                <!-- trading history area start -->
                <div class="col-lg-6">
                    <div class="card">
                        <div class="card-body" style="height: 500px;">
                            <div class="d-sm-flex justify-content-between align-items-center">
                                <h4 class="header-title">交易详情</h4>
                                <div class="trd-history-tabs">
                                    <ul class="nav" role="tablist">
                                        <li>
                                            <a class="active" data-toggle="tab" href="index.html#buy_order" role="tab"
                                               id="txin_btn">交易输入</a>
                                        </li>
                                        <li>
                                            <a data-toggle="tab" href="index.html#sell_order" role="tab" id="txout_btn">交易输出</a>
                                        </li>
                                    </ul>
                                </div>
                            </div>
                            <div class="trad-history mt-2" style="overflow: scroll;height: 410px;">
                                <div class="tab-content" id="myTabContent">
                                    <div class="tab-pane fade show active" id="txin" role="tabpanel">
                                        <div class="table-responsive">
                                            <table class="dbkit-table" id="txin_detail">

                                            </table>
                                        </div>
                                    </div>
                                    <div class="tab-pane fade" id="txout" role="tabpanel">
                                        <div class="table-responsive">
                                            <table class="dbkit-table" id="txout_detail">
                                                <tr class="heading-td">
                                                    <td>Amount</td>
                                                    <td>PubKeyHash</td>
                                                </tr>
                                                <tr>
                                                    <td>8964978</td>
                                                    <td>1AqjFvGkSLVcAoA1jvczBzrm6ae74zEjWM</td>
                                                </tr>
                                                <tr>
                                                    <td>8964978</td>
                                                    <td>1AqjFvGkSLVcAoA1jvczBzrm6ae74zEjWM</td>
                                                </tr>
                                                <tr>
                                                    <td>8964978</td>
                                                    <td>1AqjFvGkSLVcAoA1jvczBzrm6ae74zEjWM</td>
                                                </tr>
                                                <tr>
                                                    <td>8964978</td>
                                                    <td>1AqjFvGkSLVcAoA1jvczBzrm6ae74zEjWM</td>
                                                </tr>
                                            </table>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <!-- trading history area end -->

            </div>

            <div class="row mt-5">
                <div class="col-lg-12">
                    <div class="card">
                        <div class="card-body">
                            <h4 class="header-title">Console Log</h4>
                            <div class="mb-3" style="position: relative">
                                <pre id="terminal"></pre>
                            </div>
                            <div>
                                <button type="button" class="btn btn-flat btn-outline-dark " id="auto_bottom">保持底部
                                </button>
                                <button type="button" class="btn btn-flat btn-outline-dark " id="stop_bottom">停止滚动
                                </button>

                            </div>
                        </div>
                    </div>
                </div>

            </div>

        </div>
    </div>
    <!-- main content area end -->
    <!-- footer area start-->
    <footer>
        <div class="footer-area">
            <p>Template by <a href="https://github.com/puikinsh/srtdash-admin-dashboard">Colorlib</a>.
            </p></p>
        </div>
    </footer>
    <!-- footer area end-->
</div>
<!-- main wrapper start -->
<!-- jquery latest version -->
<script src="assets/js/vendor/jquery-2.2.4.min.js" type="text/javascript"></script>
<!-- bootstrap 4 js -->
<script src="assets/js/popper.min.js" type="text/javascript"></script>
<script src="assets/js/bootstrap.min.js" type="text/javascript"></script>
<script src="assets/js/owl.carousel.min.js" type="text/javascript"></script>
<script src="assets/js/metisMenu.min.js" type="text/javascript"></script>
<script src="assets/js/jquery.slimscroll.min.js" type="text/javascript"></script>
<script src="assets/js/jquery.slicknav.min.js" type="text/javascript"></script>

<!-- others plugins -->

<script src="assets/js/plugins.js" type="text/javascript"></script>
<script src="assets/js/base64.min.js" type="text/javascript"></script>
<script src="assets/js/jquery.toast.js" type="text/javascript"></script>
<script src="assets/js/scripts.js" type="text/javascript"></script>


<script type="text/javascript">
    var status_data;
    var peers = $('#peer_list');
    var wallets = $('#wallets');
    var balance = $('#balance');
    var blocks = $('#blocks');
    var txlist = $('#tx_list');
    var txin_detail = $('#txin_detail');
    var txout_detail = $('#txout_detail');

    var currActiveTx = null;
    var currActiveBlockHeight = null;

    function update(data) {
        status_data = data;

        if (currActiveBlockHeight == null){ // 第一次更新UI
            currActiveBlockHeight = data.Blocks[0].Height;
        }

        //更新当前节点地址
        $('#node-addr').text(data.NodeAddr);

        // 更新对等节点列表
        peers.empty();
        $.each(data.Peers, function (idx, peer) {
            peers.append(`<a href="javascript:void(0)" class="notify-item">
                                <div class="notify-text">
                                    <p>${peer.Addr}</p>
                                    <span>上次通讯：${peer.LastActive}</span>
                                </div>
                            </a>`);
        });

        // 更新余额，钱包
        var total = 0;
        wallets.empty();
        $.each(data.Wallet, function (idx, w) {
            total += w.Balance;
            wallets.append(`<li class="list-group-item d-flex justify-content-between align-items-center">
                                        ${w.Addr} <span class="badge  badge-pill">
                                    <i class="fa fa-btc"></i> ${w.Balance}</span> </li>`);
        });
        balance.html(`<i class="fa fa-btc"></i> ${total}`);

        // 更新区块列表
        blocks.empty();
        $.each(data.Blocks, function (idx, b) {
            blocks.append(`<div class="timeline-task blockitem ${currActiveBlockHeight==b.Height?'active' :''}" data-idx="${idx}" data-height="${b.Height}">
                                    <div class="icon bg1">
                                        ${b.Height}
                                    </div>
                                    <div class="tm-title">
                                        <h4>${base64tohex(b.Hash)}</h4>
                                        <span class="time"><i class="ti-time"></i>${tsformat(b.Timestamp)}</span>
                                    </div>
                                    <p>${b.Transactions.length} Transactions
                                    </p>
                                </div>`)
        });
        $('.blockitem').click(function () {
            var t = $(this);
            currActiveBlockHeight = parseInt(t.data('height'));
            $('.timeline-task.active').removeClass('active');
            t.addClass('active');
            update_tx_list(status_data.Blocks[parseInt(t.data('idx'))].Transactions);
        });

        // 更新交易列表
        function update_tx_list(tx_list) {
            currActiveTx = tx_list;
            txlist.empty();
            $.each(tx_list, function (idx, tx) {
                txlist.append(`<li class="txitem ${idx==0?'active' :''}" data-idx="${idx}">
                                    <div class="icon l">${idx}</div>
                                    ${base64tohex(tx.ID)}
                                </li>`);
            });
            $('.txitem').click(function () {
                var t = $(this);
                $('.txitem.active').removeClass('active');
                t.addClass('active');
                update_tx_detail(currActiveTx[parseInt(t.data('idx'))]);
            });
            update_tx_detail(tx_list[0])
        }

        if (currActiveTx == null)
            update_tx_list(data.Blocks[0].Transactions);


        // 更新交易详情
        function update_tx_detail(txinfo) {
            // console.log('update_tx_detail', txinfo)
            txin_detail.empty();
            txout_detail.empty();
            txin_detail.append(`<tr class="heading-td">
                                                    <td>RefTxID</td>
                                                    <td>Index</td>
                                                    <td>PubKey</td>
                                                </tr>`);
            txout_detail.append(`<tr class="heading-td">
                                                    <td>Amount</td>
                                                    <td>PubKeyHash</td>
                                                </tr>`);
            $.each(txinfo.Vin, function (idx, tx) {
                txin_detail.append(`<tr>
                                    <td>${base64tohex(tx.Txid)}</td>
                                    <td>${tx.Vout}</td>
                                    <td>${base64tohex(tx.PubKey)}</td>
                                </tr>`);
            });
            $.each(txinfo.Vout, function (idx, tx) {
                txout_detail.append(`<tr>
                                    <td>${tx.Value}</td>
                                    <td>${base64tohex(tx.PubKeyHash)}</td>
                                </tr>`);
            });
        }

    }

    function base64tohex(base64str) {
        if (base64str == null)
            return 'null';
        var base = '0123456789abcdef';
        var arrs = Uint8Array.from(atob(base64str), c => c.charCodeAt(0));
        var res = '';
        for (var i = 0; i < arrs.length; i++) {
            res += base[arrs[i] >> 4];
            res += base[arrs[i] % 16];
        }
        return res
    }

    function tsformat(unix_timestamp) {
        // Create a new JavaScript Date object based on the timestamp
        // multiplied by 1000 so that the argument is in milliseconds, not seconds.
        var date = new Date(unix_timestamp * 1000);
        // Hours part from the timestamp
        var hours = date.getHours();
        // Minutes part from the timestamp
        var minutes = "0" + date.getMinutes();
        // Seconds part from the timestamp
        var seconds = "0" + date.getSeconds();

        // Will display time in 10:30:23 format
        var formattedTime = '' + (date.getMonth() + 1) + '/' + date.getDate() + ' ' + hours + ':' + minutes.substr(-2) + ':' + seconds.substr(-2);
        return formattedTime;
    }

    function updateAjax() {
        $.getJSON('/status', function (data) {
            if (data.Status)
                update(data.Data);
            else {

            }
        });
    }

    updateAjax();
    setInterval(updateAjax, 3000);

    function error(msg) {
        $.toast({
            heading: 'Error',
            text: msg,
            position: 'top-center',
            stack: false,
            icon: 'error'
        });
    }

    function success(msg) {
        $.toast({
            heading: 'Success',
            text: msg,
            position: 'top-center',
            stack: false,
            icon: 'success'
        });
    }

    $('#submit_tx').click(function () {
        var amount = $('#tx_amount').val();
        var tx_to = $('#tx_to').val();
        if (amount == "" || tx_to == "")
            return error('输入不能为空');

        if (tx_to.length != 34)
            return error('交易地址格式不正确');

        var from = null;
        $.each(status_data.Wallet, function (idx, w) {
            if (w.Balance >= amount && w.Addr != tx_to) {
                from = w.Addr
            }
        });

        if (from == null) {
            return error('没有足够余额的钱包地址');
        }

        $.post('send', {
            from: from,
            amount: amount,
            to: tx_to
        }, function (data) {
            if (data.Status) {
                success('提交交易成功');
            } else {
                error('data.data');
            }
        })

    });
</script>
</body>

</html>
